# コンポーネント仕様: C. コントロールパネル (Controller Panel)

[<< Hub画面設計トップに戻る](../0003.hub.md)

## 1. 役割

コントロールパネルは、Canvasに表示される内容を体系的に制御するためのインターフェースです。PC版では画面左側のパネル、モバイル版ではBottomSheetとして提供されます。
以下の3つの主要なコントロール機能を担います。

- **ビュー (Hub) の選択**: 音楽を分析するための「地図」を切り替えます。
- **キー (Context) の設定**: 音楽的な文脈の中心となる「基準点」を設定します。
- **レイヤー (Information) の制御**: 地図の上に重ねる「情報」の表示/非表示を切り替えます。

---

## 2. C-1: ビューコントローラー (View Controller)

- **役割**: Canvasに描画するHub（世界観/レンズ）を切り替えます。
- **UI仕様**:
  - `[ 五度圏 ]` と `[ クロマチック ]` の2つの選択肢を持つトグルスイッチ形式のUI。
  - 現在選択されているビューが視覚的に強調されます。この選択は、後述するレイヤーコントローラーの各項目の挙動や有効/無効状態に影響します。

---

## 3. C-2: キー・コントローラー (Key Controller)

- **役割**: アプリケーションの音楽的文脈（キー/モード）を設定します。Tonic（主音）とMode（旋法）を、素早くかつ直感的に選択するためのインターフェースを提供します。
- **UI仕様**:
  - **Tonicセレクター**: 12の主音（C, C♯/D♭...）を表すボタンを水平リストとして常時表示します。
- **インタラクション**:
  - 詳細は、このコンポーネントの主要機能である **"Radial Context Menu"** のインタラクション仕様に記載します。

### インタラクション仕様: "Radial Context Menu"

#### デスクトップ (マウス操作)

1.  **トリガー**: Tonicセレクター内の主音ボタン（例: `C`）に**ホバー**します。
2.  **アクション**:
    - 0.1秒の遅延後、ホバーされた主音を中心に、利用可能なMode（Ionian, Dorian...）が円形状にアニメーション付きで出現します。
    - ユーザーはそのままマウスを動かし、目的のModeボタンを**クリック**します。
3.  **結果**: クリックと同時にキーが確定し、Mode選択メニューは消えます。

#### モバイル (タッチ操作)

1.  **トリガー**: Tonicセレクター内の主音ボタン（例: `C`）を**1回タップ**します。
2.  **アクション**:
    - タップされた主音を中心にMode選択メニューが出現し、表示が維持されます。
    - ユーザーは出現したメニューから目的のModeボタンを**2回目にタップ**します。
3.  **結果**: 2回目のタップでキーが確定し、Mode選択メニューは消えます。

---

## 4. C-3: レイヤー・コントローラー (Layer Controller)

- **役割**: 選択されたHubの上に重ねる、音楽理論の各レイヤーの可視性を制御します。
- **UI仕様**:
  - 各レイヤー群はアコーディオンUIで分類され、クリックで展開/折りたたみが可能です。
  - 各項目の横には情報アイコン `(?)` を配置し、クリックでライブラリ画面の該当項目へ遷移します。
- **基本挙動**:
  - **音声再生**: レイヤーの種類に応じて、単音（スケールなど）または和音（コードなど）が再生されます。
  - **動的な有効/無効化**: 現在のビュー（五度圏/クロマチック）で意味をなさないレイヤーは、非活性（disabled）状態で表示されます。

### 4.1. アコーディオン1: スケールレイヤー (Scale Layers)

音階（単音の集まり）の構造と特性を可視化します。

| コントロール要素   | UI種別         | 詳細と挙動                                                                                                                                                                                                                                                                                                                          |
| :----------------- | :------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **スケールの選択** | ドロップダウン | `メジャースケール` `ナチュラルマイナー`等を選択。<br>選択したスケールの構成音をCanvas上にハイライトし、音声を順次再生する。<br>**【五度圏】**: 構成音に対応する外側のキー名（テキスト）をハイライト。<br>**【クロマチック】**: 構成音を頂点とした多角形を描画し、スケールの幾何学的な形状を可視化。                                 |
| **モードの表示**   | トグルスイッチ | ONにするとモード選択肢(`Ionian`, `Dorian`...)を表示。<br>選択したモードの構成音をハイライトし、音声を順次再生する。<br>**【五度圏】**: モードの特性（明るさ/暗さ）に応じて、Lydian（最も明るい）からLocrian（最も暗い）へのグラデーションで色分けする。<br>**【クロマチック】**: 各モードが持つユニークな幾何学的形状を可視化する。 |

### 4.2. アコーディオン2: コードレイヤー (Chord Layers)

和音の内部構造と、調性内での役割を可視化します。

| コントロール要素           | UI種別           | 詳細と挙動                                                                                                                                                                                                             |
| :------------------------- | :--------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ダイアトニックコード**   | トグルスイッチ   | 現在のキーのダイアトニックコード群をCanvas上に表示し、対応する和音を再生する。<br>**【五度圏】**: コードのルート音と構成音が含まれるセグメントを扇状にハイライト。<br>**【クロマチック】**: コード構成音をハイライト。 |
| ↳ **機能和声 (T/D/SD)**    | チェックボックス | 上記がONの時のみ有効。<br>**【五度圏】**: 各ダイアトニックコードを機能（トニック/ドミナント/サブドミナント）に応じて明確に色分けする。<br>**【クロマチック】**: この機能は無効。                                       |
| **コード構成音の図形表示** | トグルスイッチ   | **クロマチックサークルでのみ有効。**<br>ONにすると、選択されたコードの構成音を頂点とした幾何学図形を描画する。転回形の表示もこれに連動する。                                                                           |

### 4.3. アコーディオン3: 関係性レイヤー (Relationship Layers)

キー（調）やコードが、他の要素とどう関わり合っているかを可視化します。

| コントロール要素         | UI種別         | 詳細と挙動                                                                                                                                                                                                                                                                             |
| :----------------------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **近親調**               | トグルスイッチ | **五度圏でのみ有効。**<br>現在のキーの近親調（同主調、平行調、属調、下属調など）をハイライトし、クリックでそのキーの主和音を再生する。                                                                                                                                                 |
| **ドミナントモーション** | トグルスイッチ | **五度圏でのみ有効。**<br>V7→I に代表されるドミナントモーションや、セカンダリー・ドミナントの動きを矢印で可視化する。モーションの終着点のコードを再生し、解決感を聴覚的に提示する。                                                                                                    |
| **トライトーン代理**     | トグルスイッチ | 選択したドミナントセブンスコード（V7）のトライトーン代理関係にあるコードをハイライトする。クリックで両方のコードの和音を再生し、響きの類似性を体感させる。<br>**【五度圏】**: 対極に位置する代理キーをハイライト。<br>**【クロマチック】**: 対角線上に位置する代理コードをハイライト。 |
| **ボイス・リーディング** | トグルスイッチ | **クロマチックサークルでのみ有効。**<br>コード進行が発生した際に、各構成音が最も近い次の構成音へどう動くか（ボイスリーディング）を線で結び、視覚的に表示する。音声は再生せず、視覚的な繋がりに集中させる。                                                                             |
