# コンポーネント仕様: C. コントロールパネル (Controller Panel)

[<< Hub画面設計トップに戻る](../0003.hub.md)

## 1. 役割

コントロールパネルは、Canvasに表示される内容を体系的に制御するためのインターフェースです。PC版では画面左側のパネル、

- **モバイル**:

  - 画面下部の「タブバー」で「Controller」を選択した際に、コンテンツエリアに表示されます。
  - 縦スクロールで全項目にアクセスします。

- **ビュー (Hub) の選択**: 音楽を分析するための「地図」を切り替えます。
- **キー (Context) の設定**: 音楽的な文脈の中心となる「基準点」を設定します。
- **レイヤー (Information) の制御**: 地図の上に重ねる「情報」の表示/非表示を切り替えます。

---

## 2. C-1: ビューコントローラー (View Controller)

- **役割**: Canvasに描画するHub（世界観/レンズ）を切り替えます。
- **UI仕様**:
  - `[ 五度圏 ]` と `[ クロマチック ]` の2つの選択肢を持つトグルスイッチ形式のUI。
  - 現在選択されているビューが視覚的に強調されます。この選択は、後述するレイヤーコントローラーの各項目の挙動や有効/無効状態に影響します。

---

## 3. C-2: キー・コントローラー (Key Controller)

- **役割**: アプリケーションの音楽的文脈（キー/モード）を設定します。**「同主調（Parallel）」**と**「平行調（Relative）」**という2つの異なる視点から、Tonic（主音）とMode（旋法）を直感的に選択・探求するためのインターフェースを提供します。

- **UI仕様**:
  - **モード選択タブ**: `[ Parallel Mode ]` と `[ Relative Mode ]` の2つのタブで、キーの選択方式を切り替える。デフォルトは `Parallel Mode`。
  - **`Parallel Mode` 時 (同主調)**:
    - **Rootセレクター**: 12の主音（C, C♯/D♭...）を検索・選択するためのドロップダウンメニュー。
    - **Modeスライダー**: 7つのモード（Lydian...Locrian）を「#系」から「♭系」への連続的な変化として表現するスライダー。
  - **`Relative Mode` 時 (平行調)**:
    - **Major Keyセレクター**: 12のメジャーキー（C Major, G Major...）を基準として選択するドロップダウンメニュー。
    - **Modeスライダー**: 選択したメジャーキーのダイアトニックモード（Ionian, Dorian...）を7段階で選択するスライダー。

### 構成イメージと設計思想

```
┌──────────────────────────────────────────┐
│ [ Parallel Mode ] [ Relative Mode ]              │
└──────────────────────────────────────────┘

// Parallel Mode (同主調)
┌──────────────────────────────────────────┐
│ Root:       [ C ▼ ]                         │
│ Mode:       # ━━━━━━━●━━━━━━━━ ♭          │
│             Lyd Ion Mix Dor Aeo Phr Loc      │
└──────────────────────────────────────────┘

// Relative Mode (平行調)
┌──────────────────────────────────────────┐
│ Major Key:  [ C Major ▼ ]                    │
│ Mode:       Major ━━━●━━━━━━━━━━━ minor    │
│             I   ii  iii  IV   V   vi  vii°   │
└──────────────────────────────────────────┘
```

このUIは、音楽理論における2つの重要なキーの関係性（同主調と平行調）を体感的に学習するために設計されています。

- **なぜタブUIなのか？**: 「同主調」と「平行調」は、キーを捉えるための根本的に異なるレンズ（視点）である。タブUIはこれらの概念を明確に分離し、ユーザーが今どちらの文脈で操作しているかを常に意識できるようにする。これにより、両者の違いと関係性についての理解を深める。
- **なぜスライダーなのか？**: どちらのモードでも、モード間の「相対的な関係性」の探求が中核となる。
  - **Parallelスライダー**: モードを「明るい（#系）」⇔「暗い（♭系）」という連続的なスペクトラムとして捉えることを可能にする。
  - **Relativeスライダー**: メジャーキーという一つの集合（ダイアトニックスケール）内での各モードの「位置（ディグリー）」を視覚的に理解させる。
- **インタラクティブな学習体験**: いずれのモードでも、セレクターやスライダーを操作するとCanvas上の表示がリアルタイムに変化し、「キーの変化」がもたらす視覚的・聴覚的な結果を直接的にフィードバックする。

### インタラクション仕様

| UI要素                       | タブ       | 操作     | アクション                                                                                                                                                                                     |
| :--------------------------- | :--------- | :------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **モード選択タブ**           | -          | クリック | `Parallel Mode` と `Relative Mode` の表示を切り替える。                                                                                                                                        |
| **Root ドロップダウン**      | `Parallel` | クリック | 12の主音リストを展開・選択し、グローバルなキーのRootを更新する。                                                                                                                               |
| **Mode スライダー**          | `Parallel` | ドラッグ | LydianからLocrianまでの7つのモードを連続的に変化させ、確定時にグローバルなキーのModeを更新する。                                                                                               |
| **Major Key ドロップダウン** | `Relative` | クリック | 12のメジャーキーリストを展開・選択し、グローバルなキーをそのメジャーキーのIonianモード（例: C MajorならC Ionian）に更新する。                                                                  |
| **Mode スライダー**          | `Relative` | ドラッグ | 選択中のメジャーキーを基準とした7つのダイアトニックモード（I, ii, iii...）を切り替える。例えば`C Major`基準で`vi`を選択すると、グローバルなキーが`A Aeolian`に更新される。                     |
| **現在値表示**               | 両方       | -        | 現在のRootとModeの組み合わせが「Current Key: C Ionian」のようにテキストでリアルタイムに表示される。`Relative Mode`時はディグリーネームも併記（例: `A Aeolian (vi)`）すると、より分かりやすい。 |

### デザインに関する補足提案

- **背景グラデーション**: スライダーのトラック部分に、調号の特性を表現するグラデーション（例: 黄色系 ↔ 紫色系）を適用し、現在のモード特性を視覚的に補助する。
- **つまみのデザイン**: スライダーのつまみ（thumb）を操作しやすいように少し大きめに設計し、選択中のモード名（例: "Ionian"）をつまみの上または内部に表示することで、視認性を高める。
- **ラベル表記**: スライダーの両端に「#多」「♭多」と表記し、各モードが持つ調号の特性（シャープ系/フラット系）を客観的に示す。解釈的な表現（明るい/暗い）ではなく、音楽理論的事実を優先する。

---

## 4. C-3: レイヤー・コントローラー (Layer Controller)

- **役割**: 選択されたHubの上に重ねる、音楽理論の各レイヤーの可視性を制御します。
- **UI仕様**:
  - 各レイヤー群はアコーディオンUIで分類され、クリックで展開/折りたたみが可能です。
  - 各項目の横には情報アイコン `(?)` を配置し、クリックでライブラリ画面の該当項目へ遷移します。
- **基本挙動**:
  - **音声再生**: レイヤーの種類に応じて、単音（スケールなど）または和音（コードなど）が再生されます。
  - **動的な有効/無効化**: 現在のビュー（五度圏/クロマチック）で意味をなさないレイヤーは、非活性（disabled）状態で表示されます。

### 4.1. アコーディオン1: スケールレイヤー (Scale Layers)

音階（単音の集まり）の構造と特性を可視化します。

| コントロール要素   | UI種別         | 詳細と挙動                                                                                                                                                                                                                                                                                                                      |
| :----------------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **スケールの選択** | ドロップダウン | `メジャースケール` `ナチュラルマイナー`等を選択。<br>選択したスケールの構成音をCanvas上にハイライトし、音声を順次再生する。<br>**【五度圏】**: 構成音に対応する外側のキー名（テキスト）をハイライト。<br>**【クロマチック】**: 構成音を頂点とした多角形を描画し、スケールの幾何学的な形状を可視化。                             |
| **モードの表示**   | トグルスイッチ | ONにするとモード選択肢(`Ionian`, `Dorian`...)を表示。<br>選択したモードの構成音をハイライトし、音声を順次再生する。<br>**【五度圏】**: モードの調号特性（#系/♭系）に応じて、Lydian（最も#系）からLocrian（最も♭系）へのグラデーションで色分けする。<br>**【クロマチック】**: 各モードが持つユニークな幾何学的形状を可視化する。 |

### 4.2. アコーディオン2: コードレイヤー (Chord Layers)

和音の内部構造と、調性内での役割を可視化します。

| コントロール要素           | UI種別           | 詳細と挙動                                                                                                                                                                                                             |
| :------------------------- | :--------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ダイアトニックコード**   | トグルスイッチ   | 現在のキーのダイアトニックコード群をCanvas上に表示し、対応する和音を再生する。<br>**【五度圏】**: コードのルート音と構成音が含まれるセグメントを扇状にハイライト。<br>**【クロマチック】**: コード構成音をハイライト。 |
| ↳ **機能和声 (T/D/SD)**    | チェックボックス | 上記がONの時のみ有効。<br>**【五度圏】**: 各ダイアトニックコードを機能（トニック/ドミナント/サブドミナント）に応じて明確に色分けする。<br>**【クロマチック】**: この機能は無効。                                       |
| **コード構成音の図形表示** | トグルスイッチ   | **クロマチックサークルでのみ有効。**<br>ONにすると、選択されたコードの構成音を頂点とした幾何学図形を描画する。転回形の表示もこれに連動する。                                                                           |

### 4.3. アコーディオン3: 関係性レイヤー (Relationship Layers)

キー（調）やコードが、他の要素とどう関わり合っているかを可視化します。

| コントロール要素         | UI種別         | 詳細と挙動                                                                                                                                                                                                                                                                             |
| :----------------------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **近親調**               | トグルスイッチ | **五度圏でのみ有効。**<br>現在のキーの近親調（同主調、平行調、属調、下属調など）をハイライトし、クリックでそのキーの主和音を再生する。                                                                                                                                                 |
| **ドミナントモーション** | トグルスイッチ | **五度圏でのみ有効。**<br>V7→I に代表されるドミナントモーションや、セカンダリー・ドミナントの動きを矢印で可視化する。モーションの終着点のコードを再生し、解決感を聴覚的に提示する。                                                                                                    |
| **トライトーン代理**     | トグルスイッチ | 選択したドミナントセブンスコード（V7）のトライトーン代理関係にあるコードをハイライトする。クリックで両方のコードの和音を再生し、響きの類似性を体感させる。<br>**【五度圏】**: 対極に位置する代理キーをハイライト。<br>**【クロマチック】**: 対角線上に位置する代理コードをハイライト。 |
| **ボイス・リーディング** | トグルスイッチ | **クロマチックサークルでのみ有効。**<br>コード進行が発生した際に、各構成音が最も近い次の構成音へどう動くか（ボイスリーディング）を線で結び、視覚的に表示する。音声は再生せず、視覚的な繋がりに集中させる。                                                                             |
