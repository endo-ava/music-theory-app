# `vaul`製ボトムシートにおけるスロースワイプ時のスクロール競合問題

## 1. 問題の概要

`vaul`ライブラリで実装したボトムシートにおいて、シート内のコンテンツがスクロール可能である場合、シート自体をゆっくりとスワイプ（ドラッグ）して高さを変えようとすると、意図せずシートが元の位置（スナップポイント）に戻ってしまう現象が発生した。

- **再現手順:**
  1. スクロール可能なコンテンツを持つ`vaul`製ボトムシートを表示する。
  2. シートのドラッグハンドルやヘッダー部分を掴み、ゆっくりと上下にスワイプする。
  3. シートが少しだけ追従した後、カクッと元のスナップポイントに引き戻される。

## 2. 根本原因

この問題の根本原因は、**`vaul`が処理するドラッグジェスチャーと、ブラウザがネイティブに処理するスクロールイベントの競合**にある。

1.  ユーザーが画面をゆっくりスワイプすると、ブラウザはこれを「ドラッグ」と「スクロール」の両方の可能性があるジェスチャーとして解釈し、`touchmove` イベントなどを発火させる。
2.  ボトムシート内のコンテンツエリア (`overflow-y-auto`を持つ要素) がこのイベントを受け取ると、スクロール処理を開始しようとする。
3.  同時に、`vaul`ライブラリもこのジェスチャーをシートの高さ変更操作としてリッスンしている。
4.  しかし、コンテンツエリアのスクロールがわずかでも始まると、`vaul`は「これはシートのドラッグではなく、コンテンツのスクロールが目的だ」と判断し、進行中だったドラッグ操作をキャンセルしてしまう。その結果、シートが元のスナップポイントにリセットされていた。

## 3. 対策

このイベント競合を解決するため、`react-remove-scroll`ライブラリを導入した。

具体的には、ボトムシート内のスクロール可能なコンテンツエリアを、`react-remove-scroll`が提供する`<RemoveScroll>`コンポーネントでラップする。

### 修正前のコード (`MobileBottomSheet.tsx`)

```tsx
// ...
{
  /* コンテンツエリア */
}
<div className="flex-1 overflow-y-auto p-6">
  <ControllerPanel />
</div>;
// ...
```

### 修正後のコード (`MobileBottomSheet.tsx`)

```tsx
import { RemoveScroll } from 'react-remove-scroll';
// ...

// ...
{
  /* コンテンツエリア */
}
<RemoveScroll as="div" className="flex-1 overflow-y-auto p-6">
  <ControllerPanel />
</RemoveScroll>;
// ...
```

### なぜこれで解決するのか

`<RemoveScroll>`コンポーネントは、その子要素（今回は`<ControllerPanel />`を内包する`div`) 内部で発生したポインターイベント (`touchmove` や `wheel` など) が、親要素へ伝播（バブリング）するのを防ぐ役割を果たす。

- `<RemoveScroll>`がコンテンツエリア内でのスワイプ操作を検知すると、そのイベントを捕捉し、`event.stopPropagation()`を内部で呼び出す。
- これにより、イベントが`vaul`のルートコンポーネントまで到達しなくなる。
- 結果として、`vaul`はコンテンツエリア内でのスクロール操作を無視し、シート全体のドラッグ操作のみに集中できる。これにより、ドラッグとスクロールの責務が明確に分離され、競合が解消される。

## 4. 教訓

- **ジェスチャーとスクロールの共存に注意:** ドラッグ、スワイプなどのカスタムジェスチャーを持つコンポーネント内に、ネイティブのスクロール領域を配置する場合、イベントの競合は頻繁に発生しうる問題である。
- **イベント伝播の制御:** このような問題の多くは、イベントの伝播（バブリング）を適切に制御することで解決できる。`event.stopPropagation()`の適用が有効な手段となる。
- **専門ライブラリの活用:** `react-remove-scroll`や`react-focus-lock`のようなライブラリは、モーダルやドロワーといった複雑なUIコンポーネントにおけるフォーカス管理やスクロール制御の定石をカプセル化しており、同様の問題に対する堅牢な解決策を提供する。
