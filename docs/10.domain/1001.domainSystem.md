# 音楽理論ドメイン設計書

## 1. はじめに

### 1.1. 設計思想

本ドキュメントは、音楽理論のドメインモデルを定義するものである。この設計の核心は、音を単なる数値データとして扱うのではなく、音楽理論が内包する**「関係性」「構造」「文脈」といった抽象的な概念そのものをコードで表現する**ことにある。これにより、堅牢で拡張性が高く、かつドメインの本質を反映したソフトウェアの構築を目指す。

音楽理論は数学的基盤を持ちながらも、人間の聴覚的認知や文化的文脈と密接に関わる複雑な体系である。本設計は、この二面性を適切にモデル化し、計算的正確性と音楽的直観性の両立を図る。

### 1.2. 対象ドメイン

本設計書は、音楽理論の中でも特に**調性和声（Tonal Harmony）**に関連するコンテキストを対象とする。具体的には：

- **ピッチクラス理論**: 12平均律における音名とその関係性
- **インターバル理論**: 音程の数学的・聴覚的性質
- **スケール理論**: 音階の構造とモーダルな関係性
- **コード理論**: 和音の構造と機能的役割
- **調性理論**: キーと和声機能の体系
- **旋風理論**: モード体系

---

## 2. ドメインモデルの構成要素

本ドメインモデルは、ドメイン駆動設計（DDD）の原則に従い、「値オブジェクト」「集約」によって構成される。

### 2.1. オブジェクト一覧（概要）

<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md
| オブジェクト名 | 区分 | 責務 | たとえ |
| :-------------------- | :--------------- | :------------------------------------------------- | :----------- |
| **`PitchClass`** | 値オブジェクト | オクターブに依存しない12の音名を表現 | 色の名前 |
| **`Interval`** | 値オブジェクト | 2音間の相対的な距離（関係性）を定義 | ものさし |
| **`Note`** | 値オブジェクト | 具体的な音の高さ（ピッチ+オクターブ）を表現 | 特定の絵の具 |
| **`ScalePattern`** | 値オブジェクト | あらゆる音階の構造を定義する設計図 | 建築設計図 |
| **`ChordPattern`** | 値オブジェクト | あらゆる和音の構造を定義する設計図 | 家具設計図 |
| **`Scale`** | 集約 | 特定のルート音から生成された具体的な音階 | 完成した建物 |
| **`Chord`** | 集約 | 同時に鳴る音の集合（和音） | 完成した家具 |
| **`IMusicalContext`** | インターフェース | あらゆる音楽的「世界」が持つべき共通の契約 | 国家憲法 |
| **`Key`** | 集約 | 機能和声に基づく音楽の文脈を定義する調性システム | 中央集権国家 |
| **`ModalContext`** | 集約 | 旋律的響きに基づく音楽の文脈を定義する旋法システム | 自由な共同体 |
=======
| オブジェクト名 | 区分 | 責務 | たとえ |
| :----------------- | :------------- | :------------------------------------------- | :----------------- |
| **`PitchClass`** | 値オブジェクト | オクターブに依存しない12の音名を表現 | 色の名前 |
| **`Interval`** | 値オブジェクト | 2音間の相対的な距離（関係性）を定義 | ものさし |
| **`Note`** | 値オブジェクト | 具体的な音の高さ（ピッチ+オクターブ）を表現 | 特定の絵の具 |
| **`ScalePattern`** | 値オブジェクト | あらゆる音階の構造を定義する設計図 | 建築設計図 |
| **`ChordPattern`** | 値オブジェクト | あらゆる和音の構造を定義する設計図 | 家具設計図 |
| **`Scale`** | 集約 | 特定のルート音から生成された具体的な音階 | 完成した建物 |
| **`Chord`** | 集約 | 同時に鳴る音の集合（和音） | 完成した家具 |
| **`IMusicalContext`** | インターフェース | あらゆる音楽的「世界」が持つべき共通の契約 | 国家憲法 |
| **`Key`** | 集約 | 機能和声に基づく音楽の文脈を定義する調性システム | 中央集権国家 |
| **`ModalContext`** | 集約 | 旋律的響きに基づく音楽の文脈を定義する旋法システム | 自由な共同体 |

> > > > > > > Stashed changes:docs/10.domain/1001.domainSystem.md

### 2.2. 値オブジェクト (Value Objects)

値オブジェクトは、音楽理論における不変の概念を表現し、等価性は値によって決定される。

#### 2.2.1. PitchClass（音名）

**責務**: オクターブに依存しない12の音名クラスを表現する。

**音楽理論的背景**:

- 12平均律における基本単位
- エンハーモニック等価性の管理（C# = D♭）
- 五度圏における位置関係の保持

**主要な振る舞い**:

```typescript
class PitchClass {
  readonly sharpName: string; // シャープ表記（C#）
  readonly flatName: string; // フラット表記（D♭）
  readonly index: number; // 半音階インデックス（C=0）
  readonly fifthsIndex: number; // 五度圏インデックス（C=0）

  transposeBy(interval: Interval): PitchClass;
  equals(other: PitchClass): boolean;
  getNameFor(keySignature: 'sharp' | 'flat' | 'natural'): string;
}
```

#### 2.2.2. Interval（音程）

**責務**: 二つの音高間の距離と質的関係を定義する。

**音楽理論的背景**:

- 完全音程・長短音程・増減音程の分類
- 転回音程の関係（M3 ↔ m6）
- 複音程と単音程の関係

**主要な振る舞い**:

```typescript
class Interval {
  readonly semitones: number; // 半音数
  readonly quality: IntervalQuality; // 完全・長・短・増・減
  readonly degree: number; // 度数（1-7）

  invert(): Interval;
  add(other: Interval): Interval;
  subtract(other: Interval): Interval;
}
```

#### 2.2.3. Note（絶対音高）

**責務**: ピッチクラスとオクターブを組み合わせた具体的な音高を表現する。

**音楽理論的背景**:

- 科学的音高記譜法（Scientific Pitch Notation）
- 周波数との対応関係
- MIDI番号との変換

**主要な振る舞い**:

```typescript
class Note {
  readonly _pitchClass: PitchClass;
  readonly octave: number;

  get frequency(): number;
  get midiNumber(): number;
  transposeBy(interval: Interval): Note;
}
```

#### 2.2.4. ScalePattern（スケールパターン）

**責務**: 音階の抽象的構造を定義し、モード変換機能を提供する。

**音楽理論的背景**:

- チャーチモードの理論的基盤
- モーダル・インターチェンジの原理
- 対称音階と非対称音階の分類

**主要な振る舞い**:

```typescript
class ScalePattern {
  readonly name: string;
  readonly intervals: readonly Interval[];
  readonly quality: ScaleQuality; // major, minor, diminished, etc.

  getMode(degree: number): ScalePattern;
  getCharacteristicInterval(): Interval;
  static readonly Major: ScalePattern;
  static readonly Aeolian: ScalePattern;
}
```

#### 2.2.5. ChordPattern（コードパターン）

**責務**: 和音の抽象的構造を定義し、和音品質の判定機能を提供する。

**音楽理論的背景**:

- 三度積みの原理と例外（sus, add和音）
- テンション・ノート（9th, 11th, 13th）の取り扱い
- 転回形と基本形の関係

**主要な振る舞い**:

```typescript
class ChordPattern {
  readonly nameSuffix: string;
  readonly intervals: readonly Interval[];
  readonly quality: ChordQuality; // major, minor, diminished, augmented, other

  matches(intervals: Interval[]): boolean;
  getChordDegreeName(degreeName: string): string;
  static findByIntervals(intervals: Interval[]): ChordPattern | null;
}
```

### 2.3. インターフェース：音楽的文脈 (Musical Contexts)

<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md

音楽における「世界」を定義するため、IMusicalContextインターフェースを導入する。これにより、アプリケーションは具体的な文脈（調性か旋法か）を意識することなく、抽象的な「音楽的文脈」として一貫して扱えるようになる。

=======
音楽における「世界」を定義するため、IMusicalContextインターフェースを導入する。これにより、アプリケーションは具体的な文脈（調性か旋法か）を意識することなく、抽象的な「音楽的文脈」として一貫して扱えるようになる。

> > > > > > > Stashed changes:docs/10.domain/1001.domainSystem.md

#### 2.3.1. IMusicalContext（音楽的文脈インターフェース）

**責務**: KeyやModalContextなど、あらゆる音楽的文脈が実装すべき共通の契約を定義する。

```typescript
interface IMusicalContext<T extends IAnalysisResult = IAnalysisResult> {
  readonly centerPitch: PitchClass; // 中心音（調性音楽のトニック、旋法音楽の中心音）
  readonly scale: Scale;
<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md

  get diatonicChords(): readonly Chord[];
  analyzeChord(chord: Chord): T; // 型安全な分析結果を返す
}
```

> =======
> readonly contextType: 'tonal' | 'modal'; // 文脈の種別を識別する

getDiatonicChords(): readonly Chord[];
analyzeChord(chord: Chord): T; // 型安全な分析結果を返す
}

````
>
>>>>>>> Stashed changes:docs/10.domain/1001.domainSystem.md

### 2.4. 集約 (Aggregates)

集約は、値オブジェクトを組み合わせて音楽理論の複合概念を表現し、一貫性の境界を定義する。

#### 2.4.1. Scale（具体的な音階）

**責務**: ルート音とパターンから構成される具体的な音階を管理する。

**音楽理論的背景**:

- 特定のキーにおける音階の実現
- ダイアトニック音とクロマティック音の区別
- スケール内での音の機能的役割

**主要な振る舞い**:

```typescript
class Scale {
  readonly root: PitchClass;
  readonly pattern: ScalePattern;

  getNotes(): readonly Note[];
  contains(pitchClass: PitchClass): boolean;
  getDegree(pitchClass: PitchClass): number | null;
}
````

#### 2.4.2. Chord（和音）

**責務**: ルート音とパターンから構成される和音を管理する。

**音楽理論的背景**:

- 和音の転回形と基本形
- ヴォイシングとドロップ・ヴォイシング
- 和音の機能的分析

**主要な振る舞い**:

```typescript
class Chord {
  readonly rootNote: Note;
  readonly quality: ChordPattern;

  getNotes(): readonly Note[];
  getInversion(): number;
  equals(other: Chord): boolean;
  static from(root: Note, pattern: ChordPattern): Chord;
}
```

#### 2.4.3. Key（調性）

<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md

=======

> > > > > > > Stashed changes:docs/10.domain/1001.domainSystem.md
> > > > > > > **責務**: 機能和声（Functional Harmony）のルールセットに基づき、音楽の調性的な文脈と機能的関係性を管理する。IMusicalContextを実装する。

**音楽理論的背景**:

<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md

- メジャー、またはマイナー（和声的短音階を含む）スケールに限定される
- 調的重力場（Tonal Gravity）の概念
- ダイアトニック和音の機能（トニック、ドミナント、サブドミナント）
- # 関係調（平行調・同主調・属調・下属調）の体系
- メジャー、またはマイナー（和声的短音階を含む）スケールに限定される
- 調的重力場（Tonal Gravity）の概念
- ダイアトニック和音の機能（トニック、ドミナント、サブドミナント）
- 関係調（平行調・同主調・属調・下属調）の体系
  > > > > > > > Stashed changes:docs/10.domain/1001.domainSystem.md

**主要な振る舞い**:

```typescript
class Key implements IMusicalContext {
<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md
  readonly centerPitch: PitchClass;
  readonly scale: Scale;

  // IMusicalContextの契約
  diatonicChords(): readonly Chord[];
  analyzeChord(chord: Chord): TonalChordAnalysisResult;

  // Key固有の振る舞い
  getDiatonicChordsInfo(): Chord;
=======
  readonly contextType = 'tonal';
  readonly tonic: PitchClass;
  readonly scale: Scale;

  // IMusicalContextの契約
  getDiatonicChords(): readonly Chord[];
  analyzeChord(chord: Chord): TonalChordAnalysisResult;

  // Key固有の振る舞い
  getDominantChord(): Chord;
>>>>>>> Stashed changes:docs/10.domain/1001.domainSystem.md
  getRelatedKeys(): RelatedKeysInfo;
}
```

#### 2.4.4. ModalContext（旋法）

<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md

**責務**: 特定の旋法（モード）に基づき、音楽の旋法的な文脈と響きのキャラクターを管理する。IMusicalContextを実装する。

**音楽理論的背景**:

- ドリアン、フリジアンなど、あらゆるスケールパターンを扱える
- 機能和声の強い引力（V7→I）を前提としない
- 中心音（Tonal Center）は存在するが、コード間の関係はより水平的
- # 各コードが持つのは「機能」ではなく、旋法の響きを特徴づける「キャラクター」
  **責務**: 特定の旋法（モード）に基づき、音楽の旋法的な文脈と響きのキャラクターを管理する。IMusicalContextを実装する。

**音楽理論的背景**:

- ドリアン、フリジアンなど、あらゆるスケールパターンを扱える
- 機能和声の強い引力（V7→I）を前提としない
- 中心音（Tonal Center）は存在するが、コード間の関係はより水平的
- 各コードが持つのは「機能」ではなく、旋法の響きを特徴づける「キャラクター」
  > > > > > > > Stashed changes:docs/10.domain/1001.domainSystem.md

**主要な振る舞い**:

```typescript
class ModalContext implements IMusicalContext {
<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md
  readonly centerPitch: PitchClass;
=======
  readonly contextType = 'modal';
  readonly tonalCenter: PitchClass;
>>>>>>> Stashed changes:docs/10.domain/1001.domainSystem.md
  readonly scale: Scale;

  // IMusicalContextの契約
  getDiatonicChords(): readonly Chord[];
  analyzeChord(chord: Chord): ModalChordAnalysisResult;
<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md
=======

  // ModalContext固有の振る舞い
  getCharacteristicChord(): Chord; // そのモードを特徴づける和音
>>>>>>> Stashed changes:docs/10.domain/1001.domainSystem.md
}
```

## 3. ドメインモデル関連図

各ドメインオブジェクトの関係性を以下に示す：

```mermaid
graph TB
    subgraph "基本要素 (Value Objects)"
        PC[PitchClass<br/>音名]
        INT[Interval<br/>音程]
        NOTE[Note<br/>絶対音高]
        SP[ScalePattern<br/>スケール設計図]
        CP[ChordPattern<br/>コード設計図]
    end

    subgraph "Interface"
        IMC["IMusicalContext<br/>(Interface)"]
    end

    subgraph "構造物 (Aggregates)"
        SC[Scale<br/>具体的な音階]
        CH[Chord<br/>和音]
<<<<<<< Updated upstream:docs/10.domain/03.domainSystem.md

=======

>>>>>>> Stashed changes:docs/10.domain/1001.domainSystem.md
        subgraph "音楽的文脈 (Musical Context Aggregates)"
            KEY[Key<br/>調性]
            MC[ModalContext<br/>旋法]
        end
    end

    subgraph "ドメインサービス"
        CA[ChordAnalyzer<br/>和音分析サービス]
        COF[CircleOfFifths<br/>五度圏サービス]
        AE[AudioEngine<br/>音響エンジン]
    end

    %% 抽象と具象の関係
    KEY -- implements --> IMC
    MC -- implements --> IMC

    %% 依存関係
    PC --> NOTE
    INT --> SP
    INT --> CP
    NOTE --> CH

    %% 集約への依存
    PC --> SC
    SP --> SC
    CP --> CH
    SC --> KEY
    SC --> MC

    %% サービス依存
    IMC -.-> CA
    PC --> COF
    CH --> AE
    NOTE --> AE

    %% 集約間の参照
    KEY -.-> CH
    KEY -.-> SC
```

---

## 4. 音楽理論的制約とビジネスルール

### 4.1. 不変条件（Invariants）

#### 4.1.1. PitchClassの制約

- `index`は0-11の範囲内
- `fifthsIndex`は0-11の範囲内
- エンハーモニック等価性の保持

#### 4.1.2. Intervalの制約

- `semitones`は正の整数
- 完全音程の品質制約（P1, P4, P5, P8）
- 長短音程の品質制約（M2, m2, M3, m3, M6, m6, M7, m7）

#### 4.1.3. Scaleの制約

- 7音スケールが基本（例外: ペンタトニック等）
- オクターブ内での重複禁止
- ルート音は必ず含まれる

#### 4.1.4. Chordの制約

- 最低2音以上の構成
- ルート音は必ず最低音（転回形を除く）

#### 4.1.4. Keyの制約

- ダイアトニック和音は正確に7個
- 機能和声の分類（T, D, S）は完全
- 関係調の五度圏上の距離は正確

### 4.2. ビジネスルール

#### 4.2.1. 調号の決定ルール

```typescript
// 五度圏の位置に基づく調号判定
if (tonic.fifthsIndex < SHARP_FLAT_BOUNDARY) {
  keySignature = 'sharp';
} else {
  keySignature = 'flat';
}
```

#### 4.2.2. ダイアトニック和音の生成ルール

```typescript
// 三度積みによる和音構築
const third = scaleNotes[(degree + 1) % 7];
const fifth = scaleNotes[(degree + 3) % 7];
```

#### 4.2.3. 和声機能の判定ルール

```typescript
// メジャーキーでの機能分類
const majorFunctions = {
  1: 'Tonic', // I
  2: 'Subdominant', // ii
  3: 'Tonic', // iii (代理)
  4: 'Subdominant', // IV
  5: 'Dominant', // V
  6: 'Tonic', // vi (代理)
  7: 'Dominant', // vii° (代理)
};
```

---

## 5. 拡張性とメンテナンス性

### 5.1. 新しいスケールパターンの追加

新しいスケールパターンは以下の手順で追加する：

1. `ScalePattern`クラスに静的プロパティを追加
2. `ScaleQuality`型に品質を追加（必要に応じて）
3. `Key`クラスの機能判定ロジックを更新（必要に応じて）

### 5.2. 新しいコードパターンの追加

1. `ChordPattern`クラスに静的プロパティを追加
2. `patterns`配列に追加
3. `ChordQuality`型に品質を追加（必要に応じて）

### 5.3. 新しい調性システムのサポート

- 微分音楽：`PitchClass`の拡張による24-TET等のサポート
- 旋法和声：`ScalePattern`の拡張によるモード固有の和声機能
- ジャズ和声：`ChordPattern`の拡張による複雑なテンション和音

---

## 6. パフォーマンス考慮事項

### 6.1. 計算量の最適化

#### 6.1.1. 事前計算パターン

- 全PitchClassインスタンスの事前生成
- 基本Intervalインスタンスの事前生成
- 主要なScalePattern/ChordPatternの事前生成

#### 6.1.2. キャッシュ戦略

- Keyのダイアトニック和音キャッシュ
- 音程計算結果のメモ化
- 頻繁にアクセスされる関係調情報のキャッシュ

### 6.2. メモリ使用量の最適化

#### 6.2.1. オブジェクト共有

```typescript
// 同一インスタンスの再利用
private static readonly C = new PitchClass('C', 'C', 0, 0);
```

#### 6.2.2. 不変性による安全な共有

- 値オブジェクトの完全な不変性
- 配列の`Object.freeze()`による保護

---

## 7. ディレクトリ構成

```plaintext
src/
└── domain/
    ├── common/                   # 値オブジェクト（複数集約で共有）
    │   ├── IMusicalContext.ts   # 音楽的文脈インターフェース
    │   ├── PitchClass.ts        # 音名の定義と五度圏関係
    │   ├── Interval.ts          # 音程の定義と計算
    │   ├── Note.ts              # 絶対音高の定義
    │   ├── ScalePattern.ts      # スケール設計図とモード変換
    │   ├── ChordPattern.ts      # コード設計図と品質判定
    │   └── index.ts             # 共通エクスポート
    │
    ├── scale/                   # Scale集約
    │   ├── index.ts            # Scale集約ルートとビジネスロジック
    │   └── test/               # Scale関連テスト
    │
    ├── chord/                  # Chord集約
    │   ├── index.ts           # Chord集約ルートとビジネスロジック
    │   └── test/              # Chord関連テスト
    │
    ├── key/                   # Key集約（調性音楽文脈）
    │   ├── index.ts          # Key集約ルートと調性分析
    │   └── test/             # Key関連テスト
    │
    ├── modal-context/         # ModalContext集約（旋法音楽文脈）
    │   ├── index.ts          # ModalContext集約ルートと旋法分析
    │   └── test/             # ModalContext関連テスト
    │
    ├── services/             # ドメインサービス
    │   ├── ChordAnalyzer.ts  # 和音・進行分析サービス
    │   ├── CircleOfFifths.ts # 五度圏計算サービス
    │   ├── AudioEngine.ts    # 音響エンジンサービス
    │   ├── index.ts          # サービスエクスポート
    │   └── test/             # サービステスト
    │
    └── index.ts              # ドメイン全体のエクスポート
```

---

## 8. 今後の展望

### 8.1. 短期的拡張

- ノンダイアトニック和音の体系化
- セカンダリードミナントサポート
- モーダルインターチェンジ機能

### 8.2. 中期的拡張

- ジャズ和声理論のサポート
- 現代和声（クォータル和音等）
- 音楽生成アルゴリズムの基盤

### 8.3. 長期的拡張

- 微分音楽システム
- 非西洋音楽理論
- AI/ML音楽分析との統合

---

本設計書は、音楽理論の豊かな概念を正確にコードで表現し、拡張可能で保守性の高いドメインモデルの構築を目指している。理論的厳密性と実用性のバランスを保ちながら、音楽的直観とプログラム的論理の両立を図ることが、本設計の核心である。
