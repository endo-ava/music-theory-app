# テスト戦略

本プロジェクトは、静的な情報表示アプリとは異なり、「インタラクティブな視覚表現」と「感覚的なフィードバック」そのものがプロダクトのコア価値となる。したがって、テスト戦略もその特性に合わせて最適化する。

## 1. 基本方針

**Storybookをテストの中心に据えた、ビジュアルファーストなテスト戦略**を採用する。

- **主軸 (80%)**: Storybookによるコンポーネントのインタラクションテストとビジュアルテスト。
- **補完 (20%)**: Vitestによるユーティリティ関数や複雑なロジックの単体テスト。

このアプローチにより、開発者は常に実際のブラウザ環境でコンポーネントの振る舞いと見た目を確認しながら、品質を確保することができる。

## 2. StorybookとVitestの役割分担

- **Storybookでテストするもの**:

  - Reactコンポーネント（`.tsx`）のレンダリング結果
  - ユーザー操作（クリック、ホバー等）によるコンポーネントのインタラクション
  - 特定のPropsを受け取ったときの見た目の変化
  - レスポンシブ対応やUIの状態変化（`open`/`close`など）

- **Vitestでテストするもの**:
  - UIを介さない純粋な関数（例: `src/components/CircleOfFifths/utils`内の計算ロジック）
  - カスタムフック内部の複雑な条件分岐やロジック
  - Zustandストアのアクションと状態変化
  - 数学的なエッジケースや異常系のテスト

## 3. Storybook

### 3.1. 基本思想

- **ストーリーは「生きた仕様書」**: 各コンポーネントの「状態」と「振る舞い」を網羅するカタログとして機能させる。
- **効率重視**: 個人開発の速度を落とさないよう、規約はシンプルに保ち、自動化できる部分は積極的に活用する。
- **関心の分離**: ストーリーファイル（`.stories.tsx`）は、あくまでコンポーネントの **「見せ方」と「使い方」** の定義に集中する。複雑なロジックはコンポーネントやカスタムフック内に閉じ込める。
- 基本的にメインコンポーネントのみstoryファイルを作り、サブコンポーネントは作成しない

### 3.2. CSF (Component Story Format) 3.0 規約

`Meta`オブジェクトと`Story`オブジェクトの書き方を標準化する。

**`Meta`オブジェクト (コンポーネント全体の設定):**

| プロパティ       | 用途と規約                                                                                                         | 使用例                                                                            |
| :--------------- | :----------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------- |
| **`title`**      | **必須。** Storybookのサイドバーでの階層構造を定義する。<br>`"Components/[コンポーネント名]"` の形式で統一する。   | `title: 'Components/CircleOfFifths'`                                              |
| **`component`**  | **必須。** 対象コンポーネントを指定する。`argTypes`の自動推論に不可欠。                                            | `component: CircleOfFifths`                                                       |
| **`tags`**       | **必須。** `['autodocs']` を指定し、Docsタブのドキュメントを自動生成させる。                                       | `tags: ['autodocs']`                                                              |
| **`parameters`** | **推奨。** アドオンの設定やレイアウトの指定に使う。<br>例: `layout: 'centered'` で中央揃えにする。                 | `parameters: { layout: 'centered' }`                                              |
| **`argTypes`**   | **条件付き必須。** Propsの型定義から自動推論できない、またはカスタマイズしたい場合に明示的に定義する。詳細は後述。 | `argTypes: { variant: { control: 'select', options: ['primary', 'secondary'] } }` |
| **`decorators`** | **条件付きで使用。** ストーリーに共通のContextやProviderを提供する場合に使う。詳細は後述。                         | `decorators: [WithStore]`                                                         |

**`Story`オブジェクト (個別のストーリー定義):**

| プロパティ | 用途と規約                                                                                                                                                    | 使用例                                                                                                                        |
| :--------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------- |
| **`args`** | **推奨。** コンポーネントに渡すPropsの初期値を設定する。最も基本的なストーリーは`Default`とし、最小限の`args`を設定する。                                     | `export const Default: Story = { args: { label: 'Button' } };`                                                                |
| **`play`** | **推奨。** `addon-interactions`を使い、ユーザー操作をシミュレートするテストを記述する。コンポーネントのインタラクティブな振る舞いをテストする上で**最重要**。 | `play: async ({ canvasElement }) => { const user = userEvent.setup(); await user.click(canvasElement.getByRole('button')); }` |

## 4. Vitestユニットテスト実装規約

**ファイル構成規約:**

- テストファイルは実装ファイルと同一ディレクトリ内の`test/`サブディレクトリに配置する
- テストファイル名は`[実装ファイル名].test.ts`の形式とする
- 例: `utils/validation.ts` → `utils/test/validation.test.ts`

**テストケース命名規約:**

1. **describe文**：

   - 形式: `'[モジュール名] [対象]'`
   - 例: `'validation utils'`, `'geometry utils'`
   - 関数別にネストする場合: `'[関数名]'`

2. **test文**：
   - 形式: `'[テストタイプ]: [期待する動作の日本語説明]'`
   - **正常ケース**: `'正常ケース: 有効な位置（0-11）でtrueを返す'`
   - **境界値ケース**: `'境界値ケース: 負の数でfalseを返す'`
   - **異常ケース**: `'異常ケース: 無効な位置でCircleOfFifthsErrorをスロー'`

**数値計算テスト規約:**

- 浮動小数点数の比較には`toBeCloseTo(expectedValue, precision)`を使用する
- 精度は計算の性質に応じて設定（通常は10桁: `toBeCloseTo(expected, 10)`）

**テストデータ規約:**

- 実際のアプリケーション定数（KEYS, CIRCLE_LAYOUT等）を活用する
- 音楽理論の正確性を検証するため、実際の五度圏データでテストする
- エッジケース用の仮想データと実データを明確に区別する

**カバレッジ目標:**

- ユーティリティ関数は100%のステートメント・ブランチカバレッジを目指す
- 全てのエラーパス（throw文）を網羅する
- 数学的な境界値（0, 負数, 上限値等）を必ずテストする
